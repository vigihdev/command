#!/usr/bin/env php
<?php
// console

require __DIR__ . '/../vendor/autoload.php';

use Symfony\Component\Console\Application;
use Symfony\Component\Dotenv\Dotenv;
use Symfony\Component\Filesystem\Path;
use Vigihdev\Command\Console\Git\{PushGitCommand};
use Vigihdev\Command\Console\Repository\ListRepositoryCommand;
use Vigihdev\Command\Console\Satis\{ThrubusSatisBuildCommand, LocalSatisBuildCommand};
use VigihDev\SymfonyBridge\Config\ConfigBridge;
use VigihDev\SymfonyBridge\Config\Service\ServiceLocator;
use Vigihdev\Encryption\Contracts\EnvironmentEncryptorServiceContract;
use Vigihdev\Encryption\Command\{EnvironmentBeautifulCommand, EnvironmentEncryptorCommand};

$basePath = Path::join(__DIR__, '..');

// Dotenv
$dotenv = new Dotenv();
$dotenv->usePutenv(true);
$dotenv->populate([
    'ABSPATH' => $basePath,
    'HOME_PATH' => getenv('HOME') ?? '',
]);

// ConfigBridge
ConfigBridge::boot(
    basePath: $basePath,
    configDir: 'config',
    enableAutoInjection: true
);

// Application
$app = new Application();
// Satis Group
$app->add(new ThrubusSatisBuildCommand());
$app->add(new LocalSatisBuildCommand());

// Git Group
$app->add(new PushGitCommand());

// Env Encrypt Gtoup
/** @var EnvironmentEncryptorServiceContract $service  */
if (! ServiceLocator::has(EnvironmentEncryptorServiceContract::class)) {
    throw new RuntimeException("EnvironmentEncryptorServiceContract service not found in ServiceLocator");
}
$service = ServiceLocator::get(EnvironmentEncryptorServiceContract::class);
$app->add(new EnvironmentEncryptorCommand(service: $service));
$app->add(new EnvironmentBeautifulCommand());

// Repository Group
$app->add(new ListRepositoryCommand());

$app->run();
